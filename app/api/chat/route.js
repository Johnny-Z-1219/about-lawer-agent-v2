import { NextResponse } from 'next/server';

// 模拟更复杂的法律知识库
const legalKnowledgeBase = {
  // 合同相关
  '合同': {
    keywords: ['合同', '协议', '违约', '签约', '条款'],
    responses: [
      '关于合同问题，我需要了解更多详情：',
      '1. 合同的性质（买卖、租赁、服务等）',
      '2. 争议的具体内容',
      '3. 合同签订时间和履行情况',
      '4. 目前的损失情况',
      '',
      '一般来说，合同纠纷的处理步骤：',
      '• 收集相关证据材料',
      '• 尝试协商解决',
      '• 申请调解或仲裁',
      '• 必要时提起诉讼',
      '',
      '建议您带齐合同原件及相关证据，预约面谈详细咨询。'
    ]
  },
  
  // 婚姻家庭
  '离婚': {
    keywords: ['离婚', '分居', '财产分割', '抚养权', '抚养费'],
    responses: [
      '离婚案件是一个敏感且重要的决定，主要涉及：',
      '',
      '📋 程序方面：',
      '• 协议离婚（民政局办理）',
      '• 诉讼离婚（法院审理）',
      '',
      '💰 财产分割：',
      '• 夫妻共同财产的认定',
      '• 房产、车辆、存款等分割',
      '• 债务的承担',
      '',
      '👶 子女问题：',
      '• 抚养权的争取',
      '• 抚养费的标准',
      '• 探视权的安排',
      '',
      '建议您准备好财产证明、收入证明等材料，我们可以为您制定最佳的法律策略。'
    ]
  },
  
  // 劳动争议
  '工伤': {
    keywords: ['工伤', '工作', '劳动', '辞退', '加班', '社保'],
    responses: [
      '工伤案件处理有严格的时效要求：',
      '',
      '⏰ 关键时间节点：',
      '• 30日内申请工伤认定',
      '• 15日内申请复议',
      '• 1年内申请劳动仲裁',
      '',
      '📋 需要准备的材料：',
      '• 劳动合同或劳动关系证明',
      '• 医疗诊断证明',
      '• 事故发生证明',
      '• 工伤认定申请表',
      '',
      '💵 赔偿项目包括：',
      '• 医疗费、住院费',
      '• 停工留薪期工资',
      '• 一次性伤残补助金',
      '• 护理费等',
      '',
      '工伤案件时效性很强，建议立即咨询专业律师。'
    ]
  },
  
  // 房产纠纷
  '房产': {
    keywords: ['房子', '房产', '买房', '租房', '房屋', '物业'],
    responses: [
      '房产纠纷类型多样，常见问题包括：',
      '',
      '🏠 买卖纠纷：',
      '• 合同违约（逾期交房、逾期过户）',
      '• 房屋质量问题',
      '• 中介费用争议',
      '',
      '🏠 租赁纠纷：',
      '• 押金退还问题',
      '• 租金上涨争议',
      '• 提前解约责任',
      '',
      '🏠 物业纠纷：',
      '• 物业费收费争议',
      '• 服务质量问题',
      '• 维修责任认定',
      '',
      '房产问题往往涉及金额较大，建议保留好相关证据，及时寻求专业法律帮助。'
    ]
  },
  
  // 收费咨询
  '收费': {
    keywords: ['费用', '收费', '多少钱', '价格', '律师费'],
    responses: [
      '律师收费采用多种方式：',
      '',
      '💰 收费标准：',
      '• 法律咨询：300-500元/小时',
      '• 简单案件代理：3000-8000元',
      '• 复杂案件代理：按标的额比例收费',
      '• 常年法律顾问：面议',
      '',
      '📋 影响收费的因素：',
      '• 案件复杂程度',
      '• 争议金额大小',
      '• 工作量和时间投入',
      '• 律师的专业水平',
      '',
      '🎯 优惠政策：',
      '• 首次咨询可享受半价优惠',
      '• 多案件委托有折扣',
      '• 困难群体可申请减免',
      '',
      '具体费用需要根据您的具体情况确定，欢迎预约详细咨询。'
    ]
  }
};

// 分析用户消息并生成回复
function generateResponse(userMessage) {
  const message = userMessage.toLowerCase();
  
  // 查找匹配的知识条目
  for (const [category, data] of Object.entries(legalKnowledgeBase)) {
    if (data.keywords.some(keyword => message.includes(keyword))) {
      return data.responses.join('\n');
    }
  }
  
  // 特殊问题处理
  if (message.includes('预约') || message.includes('咨询')) {
    return [
      '📞 预约咨询方式：',
      '',
      '🕘 工作时间：周一至周五 9:00-18:00',
             '📞 咨询电话：0566-5021766',
       '📧 邮箱预约：2548365492@qq.com',
       '📍 办公地址：安徽省池州市青阳县九华西路194号文化馆二楼',
      '',
      '💡 预约时请准备：',
      '• 简要描述案件性质',
      '• 说明预期咨询时间',
      '• 提供联系方式',
      '',
      '首次咨询享受半价优惠，我们会为您提供专业的法律分析和建议。'
    ].join('\n');
  }
  
  if (message.includes('你好') || message.includes('hello')) {
    return [
      '您好！欢迎咨询安徽修实律师事务所！👋',
      '',
      '我是您的专业法律助手，可以为您提供：',
      '• 基础法律问题解答',
      '• 案件类型分析',
      '• 法律风险提示',
      '• 预约咨询服务',
      '',
      '请告诉我您遇到的具体法律问题，我会尽力为您提供专业建议。'
    ].join('\n');
  }
  
  // 默认智能回复
  return [
    '感谢您的咨询！🙏',
    '',
    '根据您描述的情况，建议您：',
    '',
    '1️⃣ 详细整理相关事实和证据材料',
    '2️⃣ 明确您希望达到的目标',
    '3️⃣ 预约专业律师进行详细咨询',
    '',
    '每个案件都有其特殊性，为了给您最准确的法律建议，',
    '建议您预约面谈，我们会为您制定个性化的解决方案。',
    '',
         '📞 预约电话：0566-5021766',
     '📧 预约邮箱：2548365492@qq.com'
  ].join('\n');
}

export async function POST(request) {
  try {
    const { message } = await request.json();
    
    if (!message || typeof message !== 'string') {
      return NextResponse.json(
        { error: '请提供有效的消息内容' },
        { status: 400 }
      );
    }
    
    // 模拟处理时间
    await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 1500));
    
    const response = generateResponse(message);
    
    return NextResponse.json({
      success: true,
      response: response,
      timestamp: new Date().toISOString()
    });
    
  } catch (error) {
    console.error('Chat API Error:', error);
    return NextResponse.json(
      { error: '服务暂时不可用，请稍后再试' },
      { status: 500 }
    );
  }
} 